{{- range $appset := .Values.appsets }}
{{- $revision := $appset.revision | default "HEAD" }}
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ $appset.name }}-appset
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: "{{ $appset.repo_url }}"
        revision: "{{ $revision }}"
        files:
          - path: "{{ $appset.config_search_path }}"
  template:
    metadata:
      name: "{{`{{ .name }}`}}"
      labels:
        app.kubernetes.io/name: "{{`{{ .name }}`}}"
    spec:
      project: default
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{`{{ .namespace }}`}}"
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
        automated:
          selfHeal: true
  templatePatch: |
    spec:
      sources:
      - repoURL: {{`{{ coalesce .source.repoURL "` }}{{ $appset.repo_url }}{{`" }}`}}
        targetRevision: {{`{{ coalesce .source.targetRevision "` }}{{ $revision }}{{`" }}`}}
        {{`{{- if .source.chart }}`}}
        chart: {{`{{ .source.chart }}`}}
        {{`{{- else }}`}}
        path: {{`{{ coalesce .source.path .path }}`}}
        {{`{{- end }}`}}
        {{`{{- if .values }}`}}
        helm:
          valuesObject: {{`{{ toJson .values }}`}}
        {{`{{- end }}`}}
        {{`{{- if .values_files }}`}}
        helm:
          valueFiles:
          {{`{{- range $valueFile := .values_files }}`}}
          - $values/{{`{{ coalesce $.path "" }}`}}/{{`{{ $valueFile }}`}}
          {{`{{- end }}`}}
        {{`{{- end }}`}}
      - repoURL: {{ $appset.repo_url }}
        targetRevision: {{ $revision }}
        ref: values
      {{`{{- if .addons }}`}}
      - repoURL: {{ $appset.repo_url }}
        targetRevision: {{ $revision }}
        path: {{`{{ coalesce .path "" }}`}}/{{`{{ .addons.path }}`}}
        {{`{{- if .addons.vault }}`}}
        plugin:
          name: lovely-vault-plugin
        {{`{{- end }}`}}
      {{`{{- end }}`}}
      {{`{{- if .ignoreDifferences }}`}}
      ignoreDifferences: {{`{{ toJson .ignoreDifferences }}`}}
      {{`{{- end }}`}}
{{- end }}
