{{- range $appset := .Values.appsets }}
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ $appset.name }}-appset
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: "{{ $appset.repo_url }}"
        revision: "{{ $appset.revision }}"
        files:
          - path: "**/app-config.yaml"
  template:
    metadata:
      name: "{{`{{ .name }}`}}"
      labels:
        app.kubernetes.io/name: "{{`{{ .name }}`}}"
    spec:
      project: default
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{`{{ .namespace }}`}}"
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
        automated:
          selfHeal: true
  templatePatch: |
    spec:
      sources:
        - repoURL: {{ $appset.repo_url | default "{{`{{ .source.repoURL | default \"HEAD\" }}`}}" }}
          targetRevision: {{ $appset.revision | default "{{`{{ .source.targetRevision | default \"HEAD\" }}`}}" }}
          {{`{{- if hasKey . "source" }}`}}
          {{`{{- if hasKey .source "chart" }}`}}
          chart: {{`{{ .source.chart }}`}}
          {{`{{- else if hasKey .source "path" }}`}}
          path: {{`{{ .source.path }}`}}
          {{`{{- end }}`}}
          {{`{{- end }}`}}
{{- end }}
